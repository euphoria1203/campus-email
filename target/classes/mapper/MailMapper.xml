<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.campusmail.mapper.MailMapper">
    <resultMap id="MailResult" type="com.campusmail.entity.Mail">
        <id property="id" column="id"/>
        <result property="userId" column="user_id"/>
        <result property="accountId" column="account_id"/>
        <result property="folder" column="folder"/>
        <result property="fromAddress" column="from_address"/>
        <result property="toAddress" column="to_address"/>
        <result property="ccAddress" column="cc_address"/>
        <result property="bccAddress" column="bcc_address"/>
        <result property="subject" column="subject"/>
        <result property="content" column="content"/>
        <result property="plainContent" column="plain_content"/>
        <result property="isRead" column="is_read"/>
        <result property="isStarred" column="is_starred"/>
        <result property="isDeleted" column="is_deleted"/>
        <result property="hasAttachment" column="has_attachment"/>
        <result property="priority" column="priority"/>
        <result property="sendTime" column="send_time"/>
        <result property="receiveTime" column="receive_time"/>
        <result property="createdAt" column="created_at"/>
        <result property="updatedAt" column="updated_at"/>
    </resultMap>

    <insert id="insert" parameterType="com.campusmail.entity.Mail" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO mail (user_id, account_id, folder, from_address, to_address, cc_address, bcc_address,
                 subject, content, plain_content, is_read, is_starred, is_deleted, has_attachment,
                 priority, send_time, receive_time)
        VALUES (#{userId}, #{accountId}, #{folder}, #{fromAddress}, #{toAddress}, #{ccAddress}, #{bccAddress},
            #{subject}, #{content}, #{plainContent}, #{isRead}, #{isStarred}, #{isDeleted}, #{hasAttachment},
            #{priority}, #{sendTime}, #{receiveTime})
    </insert>

    <update id="update" parameterType="com.campusmail.entity.Mail">
        UPDATE mail
        SET subject = #{subject}, content = #{content}, plain_content = #{plainContent},
            to_address = #{toAddress}, cc_address = #{ccAddress}, bcc_address = #{bccAddress},
            is_read = #{isRead}, is_starred = #{isStarred}, is_deleted = #{isDeleted},
            has_attachment = #{hasAttachment}, folder = #{folder},
            priority = #{priority}, send_time = #{sendTime}, receive_time = #{receiveTime}
        WHERE id = #{id}
    </update>

    <delete id="delete">
        DELETE FROM mail WHERE id = #{id}
    </delete>

    <select id="findById" resultMap="MailResult">
        SELECT * FROM mail WHERE id = #{id} AND is_deleted = 0
    </select>

    <select id="findByIdIncludingDeleted" resultMap="MailResult">
        SELECT * FROM mail WHERE id = #{id}
    </select>

    <select id="findByUserId" resultMap="MailResult">
        SELECT * FROM mail WHERE user_id = #{userId} AND is_deleted = 0 ORDER BY receive_time DESC, send_time DESC
    </select>

    <select id="findByUserIdAndFolder" resultMap="MailResult">
        SELECT * FROM mail 
        WHERE user_id = #{userId} AND folder = #{folder} AND is_deleted = 0 
        ORDER BY receive_time DESC, send_time DESC
    </select>

    <select id="findStarredByUserId" resultMap="MailResult">
        SELECT * FROM mail
        WHERE user_id = #{userId} AND is_starred = 1 AND is_deleted = 0
        ORDER BY receive_time DESC, send_time DESC
    </select>

    <select id="findTrashByUserId" resultMap="MailResult">
        SELECT * FROM mail
        WHERE user_id = #{userId}
          AND is_deleted = 1
          AND (folder = 'trash' OR folder LIKE 'trash:%')
        ORDER BY receive_time DESC, send_time DESC
    </select>

    <select id="findByAccountId" resultMap="MailResult">
        SELECT * FROM mail WHERE account_id = #{accountId} AND is_deleted = 0 ORDER BY receive_time DESC, send_time DESC
    </select>

    <select id="search" resultMap="MailResult">
        SELECT *,
               MATCH(subject, plain_content) AGAINST (#{keyword} IN BOOLEAN MODE) AS score
        FROM mail
        WHERE user_id = #{userId}
          AND is_deleted = 0
        <if test="folder != null and folder != ''">
            <choose>
                <when test="folder == 'starred'">
                    AND is_starred = 1
                </when>
                <when test="folder == 'trash'">
                    AND (folder = 'trash' OR folder LIKE 'trash:%')
                </when>
                <otherwise>
                    AND folder = #{folder}
                </otherwise>
            </choose>
        </if>
        <if test="accountId != null">
            AND account_id = #{accountId}
        </if>
        <if test="keyword != null and keyword != ''">
            AND (
                MATCH(subject, plain_content) AGAINST (#{keyword} IN BOOLEAN MODE)
                OR subject LIKE CONCAT('%', #{keyword}, '%')
                OR from_address LIKE CONCAT('%', #{keyword}, '%')
                OR to_address LIKE CONCAT('%', #{keyword}, '%')
                OR cc_address LIKE CONCAT('%', #{keyword}, '%')
                OR bcc_address LIKE CONCAT('%', #{keyword}, '%')
                OR plain_content LIKE CONCAT('%', #{keyword}, '%')
            )
        </if>
        ORDER BY score DESC, receive_time DESC, send_time DESC
        LIMIT #{limit} OFFSET #{offset}
    </select>

    <select id="findScheduledDue" resultMap="MailResult">
        SELECT * FROM mail
        WHERE folder = 'scheduled'
          AND is_deleted = 0
          AND send_time IS NOT NULL
          AND send_time &lt;= #{now}
        ORDER BY send_time ASC
        LIMIT #{limit}
    </select>

    <update id="markAsRead">
        UPDATE mail SET is_read = 1 WHERE id = #{id}
    </update>

    <update id="toggleStar">
        UPDATE mail SET is_starred = NOT is_starred WHERE id = #{id}
    </update>

    <update id="moveToTrash">
        UPDATE mail
        SET is_deleted = 1,
            folder = CASE
                WHEN folder = 'trash' OR folder LIKE 'trash:%' THEN folder
                ELSE CONCAT('trash:', COALESCE(folder, 'inbox'))
            END
        WHERE id = #{id}
    </update>

    <delete id="batchDelete">
        DELETE FROM mail WHERE id IN
        <foreach collection="ids" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </delete>

    <delete id="deletePermanently">
        DELETE FROM mail WHERE id IN
        <foreach collection="ids" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </delete>


    <select id="countUnreadByUserId" resultType="int">
        SELECT COUNT(*) FROM mail 
        WHERE user_id = #{userId} AND folder = 'inbox' AND is_read = 0 AND is_deleted = 0
    </select>

    <select id="countDraftsByUserId" resultType="int">
        SELECT COUNT(*) FROM mail 
        WHERE user_id = #{userId} AND folder = 'drafts' AND is_deleted = 0
    </select>
    
    <!-- ==================== 邮件统计查询 ==================== -->
    
    <select id="countTotalByUserId" resultType="Long">
        SELECT COUNT(*) FROM mail 
        WHERE user_id = #{userId} AND is_deleted = 0
    </select>
    
    <select id="countReceivedByUserId" resultType="Long">
        SELECT COUNT(*) FROM mail 
        WHERE user_id = #{userId} AND folder = 'inbox' AND is_deleted = 0
    </select>
    
    <select id="countSentByUserId" resultType="Long">
        SELECT COUNT(*) FROM mail 
        WHERE user_id = #{userId} AND folder = 'sent' AND is_deleted = 0
    </select>
    
    <select id="countStarredByUserId" resultType="Long">
        SELECT COUNT(*) FROM mail 
        WHERE user_id = #{userId} AND is_starred = 1 AND is_deleted = 0
    </select>
    
    <select id="countWithAttachmentByUserId" resultType="Long">
        SELECT COUNT(*) FROM mail 
        WHERE user_id = #{userId} AND has_attachment = 1 AND is_deleted = 0
    </select>
    
    <select id="countReceivedByUserIdAndTimeRange" resultType="Long">
        SELECT COUNT(*) FROM mail 
        WHERE user_id = #{userId} 
        AND folder = 'inbox' 
        AND is_deleted = 0
        AND receive_time BETWEEN #{startTime} AND #{endTime}
    </select>
    
    <select id="countSentByUserIdAndTimeRange" resultType="Long">
        SELECT COUNT(*) FROM mail 
        WHERE user_id = #{userId} 
        AND folder = 'sent' 
        AND is_deleted = 0
        AND send_time BETWEEN #{startTime} AND #{endTime}
    </select>
    
    <select id="getDailyMailCounts" resultType="com.campusmail.dto.DailyMailCountDTO">
        SELECT 
            DATE_FORMAT(COALESCE(receive_time, send_time), '%Y-%m-%d') as date,
            SUM(CASE WHEN folder = 'inbox' THEN 1 ELSE 0 END) as receivedCount,
            SUM(CASE WHEN folder = 'sent' THEN 1 ELSE 0 END) as sentCount
        FROM mail
        WHERE user_id = #{userId}
        AND is_deleted = 0
        AND (receive_time >= DATE_SUB(CURDATE(), INTERVAL #{days} DAY)
             OR send_time >= DATE_SUB(CURDATE(), INTERVAL #{days} DAY))
        GROUP BY DATE_FORMAT(COALESCE(receive_time, send_time), '%Y-%m-%d')
        ORDER BY date DESC
    </select>
    
    <select id="getTopContacts" resultType="com.campusmail.dto.ContactStatDTO">
        SELECT 
            contact_email as email,
            contact_name as name,
            SUM(mail_count) as totalCount,
            SUM(CASE WHEN mail_type = 'received' THEN mail_count ELSE 0 END) as receivedCount,
            SUM(CASE WHEN mail_type = 'sent' THEN mail_count ELSE 0 END) as sentCount,
            MAX(last_time) as lastContactTime
        FROM (
            -- 收到的邮件（统计发件人）
            SELECT 
                from_address as contact_email,
                (SELECT contact_name FROM contact WHERE email = from_address AND user_id = #{userId} LIMIT 1) as contact_name,
                COUNT(*) as mail_count,
                'received' as mail_type,
                MAX(receive_time) as last_time
            FROM mail
            WHERE user_id = #{userId}
            AND folder = 'inbox'
            AND is_deleted = 0
            GROUP BY from_address
            
            UNION ALL
            
            -- 发送的邮件（统计收件人）
            SELECT 
                TRIM(SUBSTRING_INDEX(SUBSTRING_INDEX(to_address, ',', numbers.n), ',', -1)) as contact_email,
                (SELECT contact_name FROM contact WHERE email = TRIM(SUBSTRING_INDEX(SUBSTRING_INDEX(to_address, ',', numbers.n), ',', -1)) AND user_id = #{userId} LIMIT 1) as contact_name,
                1 as mail_count,
                'sent' as mail_type,
                send_time as last_time
            FROM mail
            JOIN (
                SELECT 1 n UNION ALL SELECT 2 UNION ALL SELECT 3 UNION ALL SELECT 4 UNION ALL SELECT 5
                UNION ALL SELECT 6 UNION ALL SELECT 7 UNION ALL SELECT 8 UNION ALL SELECT 9 UNION ALL SELECT 10
            ) numbers ON CHAR_LENGTH(to_address) - CHAR_LENGTH(REPLACE(to_address, ',', '')) >= numbers.n - 1
            WHERE user_id = #{userId}
            AND folder = 'sent'
            AND is_deleted = 0
        ) contact_mails
        WHERE contact_email IS NOT NULL 
        AND contact_email != ''
        GROUP BY contact_email, contact_name
        ORDER BY totalCount DESC
        LIMIT #{limit}
    </select>
    
    <select id="getMailsForResponseTimeAnalysis" resultMap="MailResult">
        SELECT * FROM mail
        WHERE user_id = #{userId}
        AND folder = 'sent'
        AND is_deleted = 0
        AND send_time IS NOT NULL
        ORDER BY send_time DESC
        LIMIT 1000
    </select>
</mapper>

