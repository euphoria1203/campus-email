import{_ as P,r as g,k as oe,n as W,c as M,o as C,e as a,b as t,w as o,d as v,J as E,f as N,T as de,U as ae,h as B,F as X,D as Y,p as O,z as A,s as J,V as ce,W as me,X as pe,N as ve,Y as fe,Z as _e,H as ge,x as ne,E as S,a as he,$ as ye,v as be,u as Ce,O as te}from"./index-Dwetklps.js";import{c as xe,b as Ve,d as we,m as le}from"./mail-BVuPHEDu.js";const ke={class:"rich-editor"},ze={class:"editor-toolbar"},$e=["placeholder"],Ie={__name:"RichEditor",props:{modelValue:{type:String,default:""},placeholder:{type:String,default:"请输入邮件正文..."}},emits:["update:modelValue"],setup(U,{expose:j,emit:T}){const V=U,z=T,c=g(null),r=g("3"),y=g("#000000"),w=g(!1),n=g(""),b=g(""),p=g(null);oe(()=>{V.modelValue&&c.value&&(c.value.innerHTML=V.modelValue)}),W(()=>V.modelValue,d=>{c.value&&c.value.innerHTML!==d&&(c.value.innerHTML=d)});const m=(d,l=null)=>{var _;(_=c.value)==null||_.focus(),document.execCommand(d,!1,l)},$=d=>document.queryCommandState(d),D=()=>{},L=()=>{var d;z("update:modelValue",((d=c.value)==null?void 0:d.innerHTML)||"")},k=d=>{d.preventDefault();const l=d.clipboardData.getData("text/html")||d.clipboardData.getData("text/plain");document.execCommand("insertHTML",!1,l)},q=d=>{var _;(_=c.value)==null||_.focus();const l=window.getSelection();l&&l.rangeCount>0&&document.execCommand("fontSize",!1,d)},s=d=>{m("foreColor",d)},e=()=>{if(b.value){const d=`<a href="${b.value}" target="_blank">${n.value||b.value}</a>`;m("insertHTML",d)}w.value=!1,n.value="",b.value=""},u=()=>{var d;(d=p.value)==null||d.click()},f=d=>{const l=d.target.files[0];if(l){const _=new FileReader;_.onload=I=>{const R=`<img src="${I.target.result}" style="max-width: 100%;" />`;m("insertHTML",R)},_.readAsDataURL(l)}d.target.value=""};return j({getContent:()=>{var d;return((d=c.value)==null?void 0:d.innerHTML)||""},setContent:d=>{c.value&&(c.value.innerHTML=d)},clear:()=>{c.value&&(c.value.innerHTML="")}}),(d,l)=>{const _=v("el-button"),I=v("el-tooltip"),R=v("el-button-group"),K=v("el-divider"),F=v("el-option"),se=v("el-select"),ue=v("el-color-picker"),Z=v("el-icon"),Q=v("el-input"),ee=v("el-form-item"),ie=v("el-form"),re=v("el-dialog");return C(),M("div",ke,[a("div",ze,[t(R,null,{default:o(()=>[t(I,{content:"加粗"},{default:o(()=>[t(_,{class:E({active:$("bold")}),onClick:l[0]||(l[0]=h=>m("bold"))},{default:o(()=>[...l[16]||(l[16]=[a("span",{class:"icon-text bold"},"B",-1)])]),_:1},8,["class"])]),_:1}),t(I,{content:"斜体"},{default:o(()=>[t(_,{class:E({active:$("italic")}),onClick:l[1]||(l[1]=h=>m("italic"))},{default:o(()=>[...l[17]||(l[17]=[a("span",{class:"icon-text italic"},"I",-1)])]),_:1},8,["class"])]),_:1}),t(I,{content:"下划线"},{default:o(()=>[t(_,{class:E({active:$("underline")}),onClick:l[2]||(l[2]=h=>m("underline"))},{default:o(()=>[...l[18]||(l[18]=[a("span",{class:"icon-text underline"},"U",-1)])]),_:1},8,["class"])]),_:1}),t(I,{content:"删除线"},{default:o(()=>[t(_,{class:E({active:$("strikeThrough")}),onClick:l[3]||(l[3]=h=>m("strikeThrough"))},{default:o(()=>[...l[19]||(l[19]=[a("span",{class:"icon-text strikethrough"},"S",-1)])]),_:1},8,["class"])]),_:1})]),_:1}),t(K,{direction:"vertical"}),t(se,{modelValue:r.value,"onUpdate:modelValue":l[4]||(l[4]=h=>r.value=h),placeholder:"字号",style:{width:"90px"},size:"small",onChange:q},{default:o(()=>[t(F,{label:"小",value:"2"}),t(F,{label:"正常",value:"3"}),t(F,{label:"大",value:"4"}),t(F,{label:"较大",value:"5"}),t(F,{label:"很大",value:"6"}),t(F,{label:"最大",value:"7"})]),_:1},8,["modelValue"]),t(ue,{modelValue:y.value,"onUpdate:modelValue":l[5]||(l[5]=h=>y.value=h),size:"small",onChange:s},null,8,["modelValue"]),t(K,{direction:"vertical"}),t(R,null,{default:o(()=>[t(I,{content:"左对齐"},{default:o(()=>[t(_,{onClick:l[6]||(l[6]=h=>m("justifyLeft"))},{default:o(()=>[...l[20]||(l[20]=[a("svg",{viewBox:"0 0 24 24",width:"16",height:"16",fill:"currentColor"},[a("path",{d:"M3 3h18v2H3V3zm0 4h12v2H3V7zm0 4h18v2H3v-2zm0 4h12v2H3v-2zm0 4h18v2H3v-2z"})],-1)])]),_:1})]),_:1}),t(I,{content:"居中"},{default:o(()=>[t(_,{onClick:l[7]||(l[7]=h=>m("justifyCenter"))},{default:o(()=>[...l[21]||(l[21]=[a("svg",{viewBox:"0 0 24 24",width:"16",height:"16",fill:"currentColor"},[a("path",{d:"M3 3h18v2H3V3zm3 4h12v2H6V7zm-3 4h18v2H3v-2zm3 4h12v2H6v-2zm-3 4h18v2H3v-2z"})],-1)])]),_:1})]),_:1}),t(I,{content:"右对齐"},{default:o(()=>[t(_,{onClick:l[8]||(l[8]=h=>m("justifyRight"))},{default:o(()=>[...l[22]||(l[22]=[a("svg",{viewBox:"0 0 24 24",width:"16",height:"16",fill:"currentColor"},[a("path",{d:"M3 3h18v2H3V3zm6 4h12v2H9V7zm-6 4h18v2H3v-2zm6 4h12v2H9v-2zm-6 4h18v2H3v-2z"})],-1)])]),_:1})]),_:1})]),_:1}),t(K,{direction:"vertical"}),t(R,null,{default:o(()=>[t(I,{content:"无序列表"},{default:o(()=>[t(_,{onClick:l[9]||(l[9]=h=>m("insertUnorderedList"))},{default:o(()=>[...l[23]||(l[23]=[a("svg",{viewBox:"0 0 24 24",width:"16",height:"16",fill:"currentColor"},[a("path",{d:"M4 4h2v2H4V4zm4 0h12v2H8V4zM4 10h2v2H4v-2zm4 0h12v2H8v-2zM4 16h2v2H4v-2zm4 0h12v2H8v-2z"})],-1)])]),_:1})]),_:1}),t(I,{content:"有序列表"},{default:o(()=>[t(_,{onClick:l[10]||(l[10]=h=>m("insertOrderedList"))},{default:o(()=>[...l[24]||(l[24]=[a("svg",{viewBox:"0 0 24 24",width:"16",height:"16",fill:"currentColor"},[a("path",{d:"M3 4h2v2H3V4zm4 0h12v2H7V4zM3 10h2v2H3v-2zm4 0h12v2H7v-2zM3 16h2v2H3v-2zm4 0h12v2H7v-2z"}),a("text",{x:"3.5",y:"5.5","font-size":"4",fill:"currentColor"},"1"),a("text",{x:"3.5",y:"11.5","font-size":"4",fill:"currentColor"},"2"),a("text",{x:"3.5",y:"17.5","font-size":"4",fill:"currentColor"},"3")],-1)])]),_:1})]),_:1})]),_:1}),t(K,{direction:"vertical"}),t(I,{content:"插入链接"},{default:o(()=>[t(_,{onClick:l[11]||(l[11]=h=>w.value=!0)},{default:o(()=>[t(Z,null,{default:o(()=>[t(N(de))]),_:1})]),_:1})]),_:1}),t(I,{content:"插入图片"},{default:o(()=>[t(_,{onClick:u},{default:o(()=>[t(Z,null,{default:o(()=>[t(N(ae))]),_:1})]),_:1})]),_:1}),a("input",{ref_key:"imageInput",ref:p,type:"file",accept:"image/*",style:{display:"none"},onChange:f},null,544)]),a("div",{ref_key:"editorRef",ref:c,class:"editor-content",contenteditable:"true",onInput:L,onPaste:k,onMouseup:D,onKeyup:D,placeholder:U.placeholder},null,40,$e),t(re,{modelValue:w.value,"onUpdate:modelValue":l[15]||(l[15]=h=>w.value=h),title:"插入链接",width:"400px"},{footer:o(()=>[t(_,{onClick:l[14]||(l[14]=h=>w.value=!1)},{default:o(()=>[...l[25]||(l[25]=[B("取消",-1)])]),_:1}),t(_,{type:"primary",onClick:e},{default:o(()=>[...l[26]||(l[26]=[B("确定",-1)])]),_:1})]),default:o(()=>[t(ie,null,{default:o(()=>[t(ee,{label:"链接文本"},{default:o(()=>[t(Q,{modelValue:n.value,"onUpdate:modelValue":l[12]||(l[12]=h=>n.value=h),placeholder:"请输入链接文本"},null,8,["modelValue"])]),_:1}),t(ee,{label:"链接地址"},{default:o(()=>[t(Q,{modelValue:b.value,"onUpdate:modelValue":l[13]||(l[13]=h=>b.value=h),placeholder:"https://"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1},8,["modelValue"])])}}},Me=P(Ie,[["__scopeId","data-v-d429d1b4"]]),He={class:"contact-select"},Se={class:"contact-option"},Ae={class:"contact-info"},Be={class:"contact-name"},Ue={class:"contact-email"},je={__name:"ContactSelect",props:{modelValue:{type:Array,default:()=>[]}},emits:["update:modelValue"],setup(U,{emit:j}){const T=U,V=j,z=g([...T.modelValue]),c=g([]),r=g(!1);W(()=>T.modelValue,p=>{z.value=[...p]},{deep:!0});const y=async p=>{if(!p){c.value=[];return}r.value=!0;try{const m=localStorage.getItem("userId");if(m){const $=await xe.search(m,p);c.value=Array.isArray($)?$:[]}else c.value=[]}catch(m){console.error("搜索联系人失败",m),c.value=[]}finally{r.value=!1}},w=p=>p.contactName&&p.contactName!==p.email?`${p.contactName} <${p.email}>`:p.email,n=p=>(p.contactName||p.email).charAt(0).toUpperCase(),b=p=>{V("update:modelValue",p)};return(p,m)=>{const $=v("el-avatar"),D=v("el-option"),L=v("el-select");return C(),M("div",He,[t(L,{modelValue:z.value,"onUpdate:modelValue":m[0]||(m[0]=k=>z.value=k),multiple:"",filterable:"",remote:"","reserve-keyword":"","remote-method":y,loading:r.value,placeholder:"输入邮箱或姓名搜索联系人",style:{width:"100%"},"allow-create":"","default-first-option":"",onChange:b},{default:o(()=>[(C(!0),M(X,null,Y(c.value,k=>(C(),O(D,{key:k.id||k.email,label:w(k),value:k.email},{default:o(()=>[a("div",Se,[t($,{size:28},{default:o(()=>[B(A(n(k)),1)]),_:2},1024),a("div",Ae,[a("span",Be,A(k.contactName||k.email),1),a("span",Ue,A(k.email),1)])])]),_:2},1032,["label","value"]))),128))]),_:1},8,["modelValue","loading"])])}}},G=P(je,[["__scopeId","data-v-e688766e"]]),Le={class:"attachment-upload"},Te={key:0,class:"upload-trigger"},De={class:"upload-text"},Ne={class:"upload-tip"},Fe={key:0,class:"attachment-list"},Re={class:"list-header"},Ee={class:"attachment-items"},Oe={class:"file-info"},Je=["title"],qe={class:"file-size"},Ke={key:1,class:"quick-add"},Pe={__name:"AttachmentUpload",props:{modelValue:{type:Array,default:()=>[]},maxSizeMB:{type:Number,default:25},maxCount:{type:Number,default:10}},emits:["update:modelValue"],setup(U,{expose:j,emit:T}){const V=U,z=T,c=g(null),r=g([]),y=g(!1);W(()=>V.modelValue,s=>{r.value=s.map(e=>({...e,uid:e.uid||Date.now()+Math.random()}))},{immediate:!0,deep:!0});const w=async(s,e)=>{if(e.length>V.maxCount){S.warning(`最多只能上传 ${V.maxCount} 个文件`);return}if(s.size>V.maxSizeMB*1024*1024){S.warning(`文件 "${s.name}" 超过 ${V.maxSizeMB}MB 限制`),e.pop();return}r.value=e,s.status==="ready"&&s.raw&&await n(s)},n=async s=>{const e=r.value.findIndex(u=>u.uid===s.uid);if(e!==-1){r.value[e].status="uploading",r.value[e].percentage=0;try{const u=await Ve.upload(s.raw,f=>{r.value[e]&&(r.value[e].percentage=f)});r.value[e].status="success",r.value[e].id=u.data.id,r.value[e].percentage=100,m(),S.success(`${s.name} 上传成功`)}catch(u){console.error("上传失败:",u),r.value[e].status="fail",S.error(`${s.name} 上传失败`)}}},b=s=>{const e=r.value.findIndex(u=>u.uid===s.uid);e>-1&&(r.value.splice(e,1),m())},p=s=>s.size>V.maxSizeMB*1024*1024?(S.warning(`文件 "${s.name}" 超过 ${V.maxSizeMB}MB 限制`),!1):!0,m=()=>{const s=r.value.map(e=>({uid:e.uid,name:e.name,size:e.size,id:e.id,status:e.status}));z("update:modelValue",s)},$=s=>{if(!s)return"0 B";const e=1024,u=["B","KB","MB","GB"],f=Math.floor(Math.log(s)/Math.log(e));return parseFloat((s/Math.pow(e,f)).toFixed(2))+" "+u[f]},D=s=>{var u;const e=(u=s.name.split(".").pop())==null?void 0:u.toLowerCase();return["jpg","jpeg","png","gif","bmp","webp","svg"].includes(e)?ae:["mp4","avi","mov","wmv","flv","mkv"].includes(e)?fe:["mp3","wav","flac","aac","ogg"].includes(e)?_e:["zip","rar","7z","tar","gz"].includes(e)?ge:ne},L=s=>{var u;const e=(u=s.name.split(".").pop())==null?void 0:u.toLowerCase();return["jpg","jpeg","png","gif","bmp","webp","svg"].includes(e)?"#67C23A":["pdf"].includes(e)?"#F56C6C":["doc","docx"].includes(e)?"#409EFF":["xls","xlsx"].includes(e)?"#67C23A":["ppt","pptx"].includes(e)?"#E6A23C":["zip","rar","7z"].includes(e)?"#909399":"#409EFF"};return j({getRawFiles:()=>r.value.map(s=>s.raw||s),clear:()=>{r.value=[],z("update:modelValue",[])}}),(s,e)=>{const u=v("el-icon"),f=v("el-upload"),H=v("el-button"),x=v("el-progress");return C(),M("div",Le,[t(f,{ref_key:"uploadRef",ref:c,"auto-upload":!1,"file-list":r.value,"on-change":w,"on-remove":b,"before-upload":p,multiple:"",drag:"",class:E({"hide-upload":!y.value})},{default:o(()=>[y.value?(C(),M("div",Te,[t(u,{size:40},{default:o(()=>[t(N(ce))]),_:1}),a("div",De,[e[2]||(e[2]=a("p",null,[B("将文件拖拽到此处，或 "),a("em",null,"点击上传")],-1)),a("p",Ne,"单个文件不超过 "+A(U.maxSizeMB)+"MB，最多上传 "+A(U.maxCount)+" 个文件",1)])])):J("",!0)]),_:1},8,["file-list","class"]),r.value.length>0?(C(),M("div",Fe,[a("div",Re,[a("span",null,"附件 ("+A(r.value.length)+")",1),t(H,{link:"",type:"primary",onClick:e[0]||(e[0]=i=>y.value=!y.value)},{default:o(()=>[B(A(y.value?"收起":"添加更多"),1)]),_:1})]),a("div",Ee,[(C(!0),M(X,null,Y(r.value,(i,d)=>(C(),M("div",{key:i.uid,class:"attachment-item"},[t(u,{size:24,color:L(i)},{default:o(()=>[(C(),O(me(D(i))))]),_:2},1032,["color"]),a("div",Oe,[a("span",{class:"file-name",title:i.name},A(i.name),9,Je),a("span",qe,A($(i.size)),1)]),i.status==="uploading"?(C(),O(x,{key:0,percentage:i.percentage||0,"stroke-width":4,style:{width:"100px"}},null,8,["percentage"])):(C(),O(u,{key:1,class:"remove-btn",onClick:l=>b(i)},{default:o(()=>[t(N(pe))]),_:1},8,["onClick"]))]))),128))])])):J("",!0),!y.value&&r.value.length===0?(C(),M("div",Ke,[t(H,{icon:N(ve),onClick:e[1]||(e[1]=i=>y.value=!0)},{default:o(()=>[...e[3]||(e[3]=[B(" 添加附件 ",-1)])]),_:1},8,["icon"])])):J("",!0)])}}},Ge=P(Pe,[["__scopeId","data-v-f0ea934d"]]),We={class:"compose-container"},Xe={class:"compose-toolbar"},Ye={class:"toolbar-actions"},Ze={class:"compose-form"},Qe={class:"form-row"},et={class:"input-wrapper"},tt={class:"form-row"},lt={class:"input-wrapper"},ot={key:0,class:"form-row"},at={key:1,class:"form-row"},nt={class:"form-row"},st={class:"form-row attachments-row"},ut={class:"editor-wrapper"},it={__name:"Compose",setup(U){const j=Ce(),T=g(null),V=g(null),z=g(!1),c=g(!1),r=g(!1),y=g([]),w=g(null),n=he({to:[],cc:[],bcc:[],subject:"",body:""}),b=g([]),p=()=>{z.value=!z.value},m=async()=>{var s,e;if(n.to.length===0){S.warning("请输入收件人");return}if(!n.subject.trim())try{await te.confirm("邮件主题为空，确定要发送吗？","提示",{confirmButtonText:"发送",cancelButtonText:"取消",type:"warning"})}catch{return}c.value=!0;try{const u=localStorage.getItem("userId"),f=b.value.filter(x=>x.id).map(x=>x.id),H={userId:u,toAddress:n.to.join(","),ccAddress:n.cc.length>0?n.cc.join(","):null,bccAddress:n.bcc.length>0?n.bcc.join(","):null,subject:n.subject||"(无主题)",content:n.body,plainContent:n.body.replace(/<[^>]*>/g,""),attachmentIds:f};await le.send(H),S.success("邮件发送成功"),j.push("/sent")}catch(u){console.error("发送邮件失败",u),S.error(((e=(s=u.response)==null?void 0:s.data)==null?void 0:e.message)||"发送失败，请重试")}finally{c.value=!1}},$=async()=>{var e,u;const s=localStorage.getItem("userId");if(!s){S.error("请先登录后再保存草稿");return}r.value=!0;try{const f=b.value.filter(x=>x.id).map(x=>x.id),H={userId:s,toAddress:n.to.join(","),ccAddress:n.cc.length>0?n.cc.join(","):null,bccAddress:n.bcc.length>0?n.bcc.join(","):null,subject:n.subject,content:n.body,plainContent:n.body?n.body.replace(/<[^>]*>/g,""):"",attachmentIds:f};await le.saveDraft(H),localStorage.setItem("mail_draft",JSON.stringify({...n,savedAt:new Date().toISOString()})),S.success("草稿已保存到服务器"),j.push("/drafts")}catch(f){console.error("保存草稿失败",f),S.error(((u=(e=f.response)==null?void 0:e.data)==null?void 0:u.message)||"保存草稿失败，请重试")}finally{r.value=!1}},D=async()=>{if(n.to.length>0||n.subject.trim()||n.body.trim()||b.value.length>0)try{await te.confirm("确定要放弃编辑吗？未保存的内容将丢失。","提示",{confirmButtonText:"放弃",cancelButtonText:"继续编辑",type:"warning"})}catch{return}j.back()};let L=null;const k=()=>{L=setInterval(()=>{(n.to.length>0||n.subject||n.body)&&localStorage.setItem("mail_draft_auto",JSON.stringify({...n,attachmentNames:b.value.map(s=>s.name),savedAt:new Date().toISOString()}))},3e4)};ye(()=>{L&&clearInterval(L)}),k();const q=async()=>{const s=localStorage.getItem("userId"),e=localStorage.getItem("email")||"",u=localStorage.getItem("username")||"默认账号";let f=[];if(s)try{f=await we.listByUser(s)||[]}catch(x){console.error("加载邮箱账号失败",x)}!f.length&&e&&(f=[{id:"fallback-account",emailAddress:e,displayName:u,isDefault:!0,isFallback:!0}]),y.value=f;const H=y.value.find(x=>x.isDefault);H?w.value=H.id:y.value.length>0?w.value=y.value[0].id:w.value=null};return oe(()=>{q()}),(s,e)=>{const u=v("el-button"),f=v("el-option"),H=v("el-select"),x=v("el-input");return C(),M("div",We,[a("div",Xe,[t(u,{onClick:D},{default:o(()=>[...e[7]||(e[7]=[B("取消",-1)])]),_:1}),a("div",Ye,[t(u,{icon:N(ne),onClick:$,loading:r.value},{default:o(()=>[...e[8]||(e[8]=[B(" 存草稿 ",-1)])]),_:1},8,["icon","loading"]),t(u,{type:"primary",icon:N(be),onClick:m,loading:c.value},{default:o(()=>[...e[9]||(e[9]=[B(" 发送 ",-1)])]),_:1},8,["icon","loading"])])]),a("div",Ze,[a("div",Qe,[e[10]||(e[10]=a("label",null,"发件人",-1)),a("div",et,[t(H,{modelValue:w.value,"onUpdate:modelValue":e[0]||(e[0]=i=>w.value=i),placeholder:"默认发件邮箱",style:{width:"260px"}},{default:o(()=>[(C(!0),M(X,null,Y(y.value,i=>(C(),O(f,{key:i.id,label:i.displayName?`${i.displayName} <${i.emailAddress}>`:i.emailAddress,value:i.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])])]),a("div",tt,[e[11]||(e[11]=a("label",null,"收件人",-1)),a("div",lt,[t(G,{modelValue:n.to,"onUpdate:modelValue":e[1]||(e[1]=i=>n.to=i)},null,8,["modelValue"]),t(u,{link:"",size:"small",onClick:p},{default:o(()=>[B(A(z.value?"隐藏":"抄送/密送"),1)]),_:1})])]),z.value?(C(),M("div",ot,[e[12]||(e[12]=a("label",null,"抄送",-1)),t(G,{modelValue:n.cc,"onUpdate:modelValue":e[2]||(e[2]=i=>n.cc=i)},null,8,["modelValue"])])):J("",!0),z.value?(C(),M("div",at,[e[13]||(e[13]=a("label",null,"密送",-1)),t(G,{modelValue:n.bcc,"onUpdate:modelValue":e[3]||(e[3]=i=>n.bcc=i)},null,8,["modelValue"])])):J("",!0),a("div",nt,[e[14]||(e[14]=a("label",null,"主题",-1)),t(x,{modelValue:n.subject,"onUpdate:modelValue":e[4]||(e[4]=i=>n.subject=i),placeholder:"请输入邮件主题",maxlength:"200","show-word-limit":""},null,8,["modelValue"])]),a("div",st,[t(Ge,{modelValue:b.value,"onUpdate:modelValue":e[5]||(e[5]=i=>b.value=i),ref_key:"attachmentRef",ref:V},null,8,["modelValue"])]),a("div",ut,[t(Me,{modelValue:n.body,"onUpdate:modelValue":e[6]||(e[6]=i=>n.body=i),ref_key:"editorRef",ref:T,placeholder:"请输入邮件正文..."},null,8,["modelValue"])])])])}}},ct=P(it,[["__scopeId","data-v-fe12091b"]]);export{ct as default};
